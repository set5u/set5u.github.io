import{w as ee,s as re,V as p,P as ne,v as te,I as ae,x as oe,B as le}from"./VGRWorker-Ds2QV2D2.js";function J(e,t,n,r,o,l,a){try{var u=e[l](a),s=u.value}catch(i){n(i);return}u.done?t(s):Promise.resolve(s).then(r,o)}function ie(e){return function(){var t=this,n=arguments;return new Promise(function(r,o){var l=e.apply(t,n);function a(s){J(l,r,o,a,u,"next",s)}function u(s){J(l,r,o,a,u,"throw",s)}a(void 0)})}}function ue(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function se(e){for(var t=1;t<arguments.length;t++){var n=arguments[t]!=null?arguments[t]:{},r=Object.keys(n);typeof Object.getOwnPropertySymbols=="function"&&(r=r.concat(Object.getOwnPropertySymbols(n).filter(function(o){return Object.getOwnPropertyDescriptor(n,o).enumerable}))),r.forEach(function(o){ue(e,o,n[o])})}return e}function fe(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);n.push.apply(n,r)}return n}function ce(e,t){return t=t??{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):fe(Object(t)).forEach(function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}),e}function pe(e,t){var n,r,o,l,a={label:0,sent:function(){if(o[0]&1)throw o[1];return o[1]},trys:[],ops:[]};return l={next:u(0),throw:u(1),return:u(2)},typeof Symbol=="function"&&(l[Symbol.iterator]=function(){return this}),l;function u(i){return function(f){return s([i,f])}}function s(i){if(n)throw new TypeError("Generator is already executing.");for(;a;)try{if(n=1,r&&(o=i[0]&2?r.return:i[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,i[1])).done)return o;switch(r=0,o&&(i=[i[0]&2,o.value]),i[0]){case 0:case 1:o=i;break;case 4:return a.label++,{value:i[1],done:!1};case 5:a.label++,r=i[1],i=[0];continue;case 7:i=a.ops.pop(),a.trys.pop();continue;default:if(o=a.trys,!(o=o.length>0&&o[o.length-1])&&(i[0]===6||i[0]===2)){a=0;continue}if(i[0]===3&&(!o||i[1]>o[0]&&i[1]<o[3])){a.label=i[1];break}if(i[0]===6&&a.label<o[1]){a.label=o[1],o=i;break}if(o&&a.label<o[2]){a.label=o[2],a.ops.push(i);break}o[2]&&a.ops.pop(),a.trys.pop();continue}i=t.call(e,a)}catch(f){i=[6,f],r=0}finally{n=o=0}if(i[0]&5)throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}}var Z="image/png",q=2,Q=[134,22,135,150,246,214,150,54];function de(e){for(var t=new DataView(e.buffer,e.byteOffset,e.byteLength),n=0,r=0;r<Q.length;r++)if(t.getUint8(n++)!==Q[r])return ee.Error("Not a babylon environment map"),null;for(var o="",l=0;l=t.getUint8(n++);)o+=String.fromCharCode(l);var a=JSON.parse(o);return a=D(a),a.specular&&(a.specular.specularDataPosition=n,a.specular.lodGenerationScale=a.specular.lodGenerationScale||.8),a}function D(e){if(e.version>q)throw new Error('Unsupported babylon environment map version "'.concat(e.version,'". Latest supported version is "').concat(q,'".'));return e.version===2||(e=ce(se({},e),{version:2,imageType:Z})),e}function ye(e,t){t=D(t);var n=t.specular,r=Math.log2(t.width);if(r=Math.round(r)+1,n.mipmaps.length!==6*r)throw new Error('Unsupported specular mipmaps number "'.concat(n.mipmaps.length,'"'));for(var o=new Array(r),l=0;l<r;l++){o[l]=new Array(6);for(var a=0;a<6;a++){var u=n.mipmaps[l*6+a];o[l][a]=new Uint8Array(e.buffer,e.byteOffset+n.specularDataPosition+u.position,u.length)}}return o}function me(e,t,n){n=D(n);var r=n.specular;if(!r)return Promise.resolve();e._lodGenerationScale=r.lodGenerationScale;var o=ye(t,n);return he(e,o,n.imageType)}function X(e,t,n,r,o,l,a,u,s,i,f){return new Promise(function(c,g){if(n){var v=t.createTexture(null,!0,!0,null,1,null,function(y){g(y)},e);r==null||r.onEffectCreatedObservable.addOnce(function(y){y.executeWhenCompiled(function(){r.externalTextureSamplerBinding=!0,r.onApply=function(d){d._bindTexture("textureSampler",v),d.setFloat2("scale",1,t._features.needsInvertingBitmap&&e instanceof ImageBitmap?-1:1)},t.scenes.length&&(t.scenes[0].postProcessManager.directRender([r],i,!0,l,a),t.restoreDefaultFramebuffer(),v.dispose(),URL.revokeObjectURL(o),c())})})}else{if(t._uploadImageToTexture(f,e,l,a),u){var w=s[a];w&&t._uploadImageToTexture(w._texture,e,l,0)}c()}})}function he(e,t){return E.apply(this,arguments)}function E(){return E=ie(function(e,t){var n,r,o,l,a,u,s,i,f,c,g,v,w,y,d,G,V,S,F,H,N,b,m,I,T,O,M,x,L,A,P=arguments;return pe(this,function(_){switch(_.label){case 0:if(n=function(h){for(var $=function(U){var K=t[h][U],Y=new Blob([K],{type:r}),B=URL.createObjectURL(Y),k=void 0;if(l._features.forceBitmapOverHTMLImageElement)k=l.createImageBitmap(Y,{premultiplyAlpha:"none"}).then(function(j){return X(j,l,a,s,B,U,h,u,f,i,e)});else{var R=new Image;R.src=B,k=new Promise(function(j,W){R.onload=function(){X(R,l,a,s,B,U,h,u,f,i,e).then(function(){return j()}).catch(function(z){W(z)})},R.onerror=function(z){W(z)}})}I.push(k)},C=0;C<6;C++)$(C)},r=P.length>2&&P[2]!==void 0?P[2]:Z,!te.IsExponentOfTwo(e.width))throw new Error("Texture size must be a power of two");return o=ae(e.width)+1,l=e.getEngine(),a=!1,u=!1,s=null,i=null,f=null,c=l.getCaps(),e.format=5,e.type=0,e.generateMipMaps=!0,e._cachedAnisotropicFilteringLevel=null,l.updateTextureSamplingMode(3,e),c.textureLOD?l._features.supportRenderAndCopyToLodForFloatTextures?c.textureHalfFloatRender&&c.textureHalfFloatLinearFiltering?(a=!0,e.type=2):c.textureFloatRender&&c.textureFloatLinearFiltering&&(a=!0,e.type=1):a=!1:(a=!1,u=!0,f={}),g=0,a?l.isWebGPU?(g=1,[4,import("./VGRWorker-Ds2QV2D2.js").then(function(h){return h.ag})]):[3,2]:[3,5];case 1:return _.sent(),[3,4];case 2:return[4,import("./VGRWorker-Ds2QV2D2.js").then(function(h){return h.af})];case 3:_.sent(),_.label=4;case 4:return s=new ne("rgbdDecode","rgbdDecode",null,null,1,null,3,l,!1,void 0,e.type,void 0,null,!1,void 0,g),e._isRGBD=!1,e.invertY=!1,i=l.createRenderTargetCubeTexture(e.width,{generateDepthBuffer:!1,generateMipMaps:!0,generateStencilBuffer:!1,samplingMode:3,type:e.type,format:5}),[3,6];case 5:if(e._isRGBD=!0,e.invertY=!0,u)for(v=3,w=e._lodGenerationScale,y=e._lodGenerationOffset,d=0;d<v;d++)switch(G=d/(v-1),V=1-G,S=y,F=(o-1)*w+y,H=S+(F-S)*V,N=Math.round(Math.min(Math.max(H,0),F)),b=new oe(l,2),b.isCube=!0,b.invertY=!0,b.generateMipMaps=!1,l.updateTextureSamplingMode(2,b),m=new le(null),m._isCube=!0,m._texture=b,f[N]=m,d){case 0:e._lodTextureLow=m;break;case 1:e._lodTextureMid=m;break;case 2:e._lodTextureHigh=m;break}_.label=6;case 6:for(I=[],T=0;T<t.length;T++)n(T);if(t.length<o){switch(M=Math.pow(2,o-1-t.length),x=M*M*4,e.type){case 0:{O=new Uint8Array(x);break}case 2:{O=new Uint16Array(x);break}case 1:{O=new Float32Array(x);break}}for(L=t.length;L<o;L++)for(A=0;A<6;A++)l._uploadArrayBufferViewToTexture(e,O,A,L)}return[2,Promise.all(I).then(function(){i&&(l._releaseTexture(e),i._swapAndDie(e)),s&&s.dispose(),u&&(e._lodTextureHigh&&e._lodTextureHigh._texture&&(e._lodTextureHigh._texture.isReady=!0),e._lodTextureMid&&e._lodTextureMid._texture&&(e._lodTextureMid._texture.isReady=!0),e._lodTextureLow&&e._lodTextureLow._texture&&(e._lodTextureLow._texture.isReady=!0))})]}})}),E.apply(this,arguments)}function ve(e,t){t=D(t);var n=t.irradiance;if(n){var r=new re;p.FromArrayToRef(n.x,0,r.x),p.FromArrayToRef(n.y,0,r.y),p.FromArrayToRef(n.z,0,r.z),p.FromArrayToRef(n.xx,0,r.xx),p.FromArrayToRef(n.yy,0,r.yy),p.FromArrayToRef(n.zz,0,r.zz),p.FromArrayToRef(n.yz,0,r.yz),p.FromArrayToRef(n.zx,0,r.zx),p.FromArrayToRef(n.xy,0,r.xy),e._sphericalPolynomial=r}}function be(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function ge(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function we(e,t,n){return ge(e.prototype,t),e}var Te=function(){function e(){be(this,e),this.supportCascades=!1}return we(e,[{key:"loadCubeData",value:function(n,r,o,l,a){if(!Array.isArray(n)){var u=de(n);if(u){r.width=u.width,r.height=u.width;try{ve(r,u),me(r,n,u).then(function(){r.isReady=!0,r.onLoadedObservable.notifyObservers(r),r.onLoadedObservable.clear(),l&&l()},function(s){a==null||a("Can not upload environment levels",s)})}catch(s){a==null||a("Can not upload environment file",s)}}else a&&a("Can not parse the environment file",null)}}},{key:"loadData",value:function(){throw".env not supported in 2d."}}]),e}();export{Te as _ENVTextureLoader};
